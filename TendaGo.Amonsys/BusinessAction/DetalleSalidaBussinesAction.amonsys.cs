    
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by Amonsys Software Factory.
//     Template: Speed Developer FrameWork Version 1.0 (For Windows Applications)
//     Web Site: http://www.amonsys.com/SDF
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------



#region using

using System;
using System.Collections.Generic;
using System.Data;

using System.Data.SqlClient;
using System.Net;
using ER.BE; 
using ER.DA; 
using System.Transactions;
using System.Configuration;

#endregion using

namespace ER.BA
{
    public partial class DetalleSalidaBussinesAction
    {
         
    //   #region Implementation
        
    //   public static DetalleSalidaEntity Save(DetalleSalidaEntity detalleSalida )
    //   {   
    //        return Save(detalleSalida,null, null);
    //   }

    //    public static void Check(string id, bool? empaquetado, bool? revisado, SqlConnection connection = null, SqlTransaction transaction = null)
    //    {
    //        bool isBAParent = false;
    //        if (connection == null)
    //        {
    //            isBAParent = true;
    //            connection = new SqlConnection(ConfigurationManager.AppSettings["TendaGo"]);
    //        }

    //        try
    //        {
    //            DetalleSalidaDataAccess.Check(id, empaquetado, revisado, connection, transaction);
    //        }
    //        catch (Exception exc)
    //        {
    //            throw exc;
    //        }
    //        finally
    //        {
    //            if (isBAParent) connection.Close();
    //        }
    //    }

    //    public static DetalleSalidaEntity Save(DetalleSalidaEntity detalleSalida , SqlConnection connection, SqlTransaction transaction)
    //   {
    //        bool isBAParent = false;
    //        if (connection == null)
    //        {
    //            isBAParent = true; 
    //            connection = new SqlConnection(ConfigurationManager.AppSettings["TendaGo"]);
    //            connection.Open();
    //            transaction = connection.BeginTransaction(System.Data.IsolationLevel.ReadCommitted);

    //        }

    //        try
    //        {

    //            #region Generacion del registro kardex
    //            StockEntity kardex = new StockEntity();
    //            kardex.IdEmpresa = detalleSalida.IdEmpresa;
    //            kardex.IdSalidaEntrada = detalleSalida.IdSalida;
    //            kardex.IdProducto = detalleSalida.IdProducto;
    //            kardex.IdLocal = detalleSalida.IdLocal;
    //            kardex.IdEstado = 1;
    //            kardex.IdTipoUnidad = detalleSalida.IdTipoUnidad;
    //            kardex.Cantidad = detalleSalida.Cantidad;
    //            #endregion

    //            switch (detalleSalida.CurrentState)
    //            {
    //                case EntityStatesEnum.Deleted:
    //                    DetalleSalidaDataAccess.Delete(detalleSalida, connection, transaction);
    //                    //DEVOLUCION AL INVENTARIO
    //                    kardex.Tipo = "D";
    //                    kardex.IdDetalle = detalleSalida.Id;
    //                    kardex.ValorUnitario = 0;
                        
    //                    //Guardo en kardex si es diferente a cotizacion
    //                    if (detalleSalida.TipoTransaccion!="CT")
    //                        StockDataAccess.Kardex(kardex, connection, transaction);

    //                    break;
    //                case EntityStatesEnum.Updated:
    //                    DetalleSalidaEntity detalleanterior = DetalleSalidaBussinesAction.LoadByPK(detalleSalida.Id,connection,transaction);
    //                    DetalleSalidaDataAccess.Update(detalleSalida, connection, transaction);
    //                    if (detalleSalida.IdTipoUnidad == detalleanterior.IdTipoUnidad)
    //                    {
    //                        //si la cantidad actual es mayor a la guardada entonces debo descontar esos items al inventario                         
    //                        if (detalleanterior.Cantidad != detalleSalida.Cantidad)
    //                        {
    //                            if (detalleanterior.Cantidad < detalleSalida.Cantidad)
    //                            {
    //                                kardex.Tipo = "S";
    //                                kardex.IdDetalle = detalleSalida.Id;
    //                                kardex.Cantidad = detalleSalida.Cantidad - detalleanterior.Cantidad;
    //                            }
    //                            else
    //                            {
    //                                //DEVOLUCION AL INVENTARIO
    //                                kardex.Tipo = "D";
    //                                kardex.IdDetalle = detalleSalida.Id;
    //                                kardex.Cantidad = detalleanterior.Cantidad - detalleSalida.Cantidad;
    //                                kardex.ValorUnitario = 0;
    //                            }

    //                            //Guardo en kardex si es diferente a cotizacion
    //                            if (detalleSalida.TipoTransaccion != "CT")
    //                                StockDataAccess.Kardex(kardex, connection, transaction);
    //                        }
    //                    }
    //                    else
    //                    {
    //                        if(detalleSalida.IdEmpresa != 1) throw new System.ArgumentException("No se pueden actualizar los saldos porque cambio el tipo de unidad", "Inventario"); 
    //                    }
    //                    break;
    //                case EntityStatesEnum.New:
    //                    detalleSalida = DetalleSalidaDataAccess.Insert(detalleSalida, connection, transaction);
    //                    //registro la salida completa la primera vez
                        
    //                    //Verificar si el producto maneja Stock o no
    //                    kardex.Tipo = "S";
    //                    kardex.IdDetalle = detalleSalida.Id;
    //                    kardex.ValorUnitario = detalleSalida.IdEmpresa != 1 ? 0 : detalleSalida.CostoVenta;

    //                    //Guardo en kardex si es diferente a cotizacion
    //                    if (detalleSalida.TipoTransaccion != "CT")
    //                        StockDataAccess.Kardex(kardex, connection, transaction);
                        
    //                    break;
    //                default:
    //                    break;
    //            }

               

    //           if (isBAParent && transaction != null)
    //           {
				//	transaction.Commit();
				//	detalleSalida.SetState(EntityStatesEnum.SavedSuccessfully);
    //           }
               
    //           return detalleSalida;
    //        }
    //        catch (Exception exc)
    //        {
    //            if (isBAParent && transaction != null)
    //            {
    //                transaction.Rollback();
    //                if ( detalleSalida != null)  detalleSalida.RollBackState();
                    
    //            }
    //            throw exc;
    //        }
    //        finally
    //        {
    //            if (isBAParent) connection.Close();
    //        }
    //    }

  
         
         
         
    //    public static DetalleSalidaEntity LoadByPK(string Id)
    //    {
    //        return LoadByPK(Id , null, null, 1);
    //    }
    //    public static DetalleSalidaEntity LoadByPK(string Id ,int deepLoadLevel)
    //    {
    //        return LoadByPK(Id , null, null, deepLoadLevel);
    //    }
        
    //    public static DetalleSalidaEntity LoadByPK(string Id, SqlConnection connection,SqlTransaction  transaction)
    //    {
    //        return LoadByPK(Id , connection, transaction, 1);
    //    }
        
    //    public static DetalleSalidaEntity LoadByPK(string Id , SqlConnection connection,SqlTransaction  transaction,int deepLoadLevel)
    //    {
    //        bool isBAParent = false;
    //        if (connection == null)
    //        {
    //            isBAParent = true;
    //            connection = new SqlConnection(ConfigurationManager.AppSettings["TendaGo"]);

    //        }
            
    //        try
    //        {

                
				//DetalleSalidaEntity detalleSalida = DetalleSalidaDataAccess.LoadByPK(Id , connection, transaction, deepLoadLevel);

    //            if (detalleSalida != null)
    //            {
    //                if (deepLoadLevel > 1)
    //                {
    //                    detalleSalida.IdSalidaAsSalida = SalidaBussinesAction.LoadByPK(detalleSalida.IdSalida, connection, transaction, deepLoadLevel - 1);
    //                    detalleSalida.IdProveedorAsEntidad = EntidadBussinesAction.LoadByPK(detalleSalida.IdProveedor, connection, transaction, deepLoadLevel - 1);
    //                    detalleSalida.IdLocalAsLocalBodega = LocalBodegaBussinesAction.LoadByPK(detalleSalida.IdLocal, connection, transaction, deepLoadLevel - 1);
    //                    detalleSalida.IdTipoUnidadAsTipoUnidad = TipoUnidadBussinesAction.LoadByPK(detalleSalida.IdTipoUnidad, connection, transaction, deepLoadLevel - 1);

    //                }

    //                detalleSalida.SetLoadedState();
    //            }

				//return detalleSalida;
    //        }
    //        catch (Exception exc)
    //        {
    //            throw exc;
    //        }
    //        finally
    //        {
    //            if (isBAParent) connection.Close();
    //        }
    //    }
        
         
    //    #endregion Implementation
          
     }
}


